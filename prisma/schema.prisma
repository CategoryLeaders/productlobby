// ProductLobby Database Schema
// Consumer-driven product demand platform with lobbying & pre-order paths

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS & AUTH
// ============================================================================

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  displayName       String   @map("display_name")
  handle            String?  @unique
  avatar            String?
  bio               String?
  location          String?
  website           String?
  twitterHandle     String?  @map("twitter_handle")
  instagramHandle   String?  @map("instagram_handle")
  tiktokHandle      String?  @map("tiktok_handle")
  linkedinHandle    String?  @map("linkedin_handle")
  interests         String[] @default([])
  phoneE164         String?  @map("phone_e164")
  phoneVerified     Boolean  @default(false) @map("phone_verified")
  emailVerified     Boolean  @default(false) @map("email_verified")
  contributionScore Int      @default(0) @map("contribution_score")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  campaigns              Campaign[]
  campaignDrafts         CampaignDraft?
  lobbies                Lobby[]
  pledges                Pledge[]
  orders                 Order[]
  brandTeams             BrandTeam[]
  brandResponses         BrandResponse[]
  pollVotes              PollVote[]
  follows                Follow[]
  reports                Report[]                @relation("reporter")
  moderationActions      ModerationAction[]      @relation("admin")
  magicLinks             MagicLink[]
  phoneVerifications     PhoneVerification[]
  sessions               Session[]
  oauthAccounts          OAuthAccount[]
  creatorRewards         CreatorReward[]
  heroRewards            HeroReward[]
  referralLinks          ReferralLink[]
  shares                 Share[]
  contributionEvents     ContributionEvent[]
  notifications          Notification[]
  campaignUpdates        CampaignUpdate[]
  updateReactions        UpdateReaction[]
  favourites             Favourite[]
  comments               Comment[]
  notificationPreference NotificationPreference?
  creatorPolls    CreatorPoll[]  @relation("creatorPolls")
  creatorPollVotes CreatorPollVote[] @relation("creatorPollVotes")
  questions Question[] @relation("questions")
  answers Question[] @relation("answers")
  questionVotes QuestionVote[]
  surveys Survey[] @relation("surveys")
  surveyResponses SurveyResponse[] @relation("surveyResponses")
  creatorRevenue CreatorRevenue?

  @@map("users")
}

model MagicLink {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([token])
  @@map("magic_links")
}

model PhoneVerification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phone     String
  code      String
  expiresAt DateTime @map("expires_at")
  verifiedAt DateTime? @map("verified_at")
  attempts  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("phone_verifications")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([token])
  @@map("sessions")
}

model OAuthAccount {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider     String   // "google", "apple"
  providerAccountId String @map("provider_account_id")
  accessToken  String?  @map("access_token")
  refreshToken String?  @map("refresh_token")
  expiresAt    DateTime? @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("oauth_accounts")
}

// ============================================================================
// BRANDS
// ============================================================================

model Brand {
  id                  String      @id @default(uuid())
  name                String
  slug                String      @unique
  website             String?
  logo                String?
  description         String?
  status              BrandStatus @default(UNCLAIMED)
  responsivenessScore Float?      @map("responsiveness_score")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  team           BrandTeam[]
  verifications  BrandVerification[]
  campaigns      Campaign[]
  responses      BrandResponse[]
  polls          Poll[]
  offers         Offer[]
  payouts        Payout[]
  surveys        Survey[]

  @@map("brands")
}

enum BrandStatus {
  UNCLAIMED
  CLAIMED
  VERIFIED

  @@map("brand_status")
}

model BrandTeam {
  brandId   String   @map("brand_id")
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      TeamRole
  createdAt DateTime @default(now()) @map("created_at")

  @@id([brandId, userId])
  @@map("brand_team")
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER

  @@map("team_role")
}

model BrandVerification {
  id         String             @id @default(uuid())
  brandId    String             @map("brand_id")
  brand      Brand              @relation(fields: [brandId], references: [id], onDelete: Cascade)
  method     VerificationMethod
  status     VerificationStatus @default(PENDING)
  token      String
  createdAt  DateTime           @default(now()) @map("created_at")
  verifiedAt DateTime?          @map("verified_at")

  @@map("brand_verifications")
}

enum VerificationMethod {
  EMAIL_DOMAIN
  DNS_TXT

  @@map("verification_method")
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED

  @@map("verification_status")
}

// ============================================================================
// CAMPAIGNS
// ============================================================================

model Campaign {
  id                  String         @id @default(uuid())
  creatorUserId       String         @map("creator_user_id")
  creator             User           @relation(fields: [creatorUserId], references: [id], onDelete: Cascade)
  title               String
  slug                String
  description         String
  category            String
  targetedBrandId     String?        @map("targeted_brand_id")
  targetedBrand       Brand?         @relation(fields: [targetedBrandId], references: [id], onDelete: SetNull)
  openToAlternatives  Boolean        @default(false) @map("open_to_alternatives")
  status              CampaignStatus @default(DRAFT)
  path                CampaignPath   @default(LOBBYING)
  currency            String         @default("GBP")
  completenessScore   Int            @default(0) @map("completeness_score")
  signalScore         Float?         @map("signal_score")
  signalScoreUpdatedAt DateTime?     @map("signal_score_updated_at")
  originStory         String?        @map("origin_story")
  pitchSummary        String?        @map("pitch_summary")
  inspiration         String?
  problemSolved       String?        @map("problem_solved")
  milestones          Json?          @default("[]")
  suggestedPrice      Decimal?       @map("suggested_price") @db.Decimal(10,2)
  priceRangeMin       Decimal?       @map("price_range_min") @db.Decimal(10,2)
  priceRangeMax       Decimal?       @map("price_range_max") @db.Decimal(10,2)
  pricingModel        String?        @map("pricing_model") // ONE_TIME, SUBSCRIPTION, FREEMIUM, PAY_WHAT_YOU_WANT
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  // Relations
  media               CampaignMedia[]
  preferenceFields    CampaignPreferenceField[]
  lobbies             Lobby[]
  pledges             Pledge[]
  updates             CampaignUpdate[]
  brandResponses      BrandResponse[]
  polls               Poll[]
  creatorPolls        CreatorPoll[]
  offers              Offer[]
  follows             Follow[]
  creatorRewards      CreatorReward[]
  heroRewards         HeroReward[]
  shares              Share[]
  contributionEvents  ContributionEvent[]
  referralLinks       ReferralLink[]
  favourites          Favourite[]
  comments            Comment[]
  questions           Question[]
  variants            CampaignVariant[]
  competitors         CompetitorExample[]
  outreachQueue       OutreachQueue[]
  surveys             Survey[]
  revenueBreakdowns   RevenueBreakdown[]

  @@unique([slug])
  @@index([status])
  @@index([path])
  @@index([targetedBrandId])
  @@index([category])
  @@index([signalScore])
  @@index([creatorUserId])
  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT
  LIVE
  PAUSED
  CLOSED

  @@map("campaign_status")
}

enum CampaignPath {
  LOBBYING
  PATH_A
  PATH_B

  @@map("campaign_path")
}

model CampaignDraft {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  formData  Json
  savedAt   DateTime @default(now()) @map("saved_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("campaign_drafts")
}

model CampaignVariant {
  id          String   @id @default(uuid())
  campaignId  String   @map("campaign_id")
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name        String   // e.g. "Size", "Color", "Material"
  options     String[] // e.g. ["Small", "Medium", "Large"]
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([campaignId])
  @@map("campaign_variants")
}

model CompetitorExample {
  id           String   @id @default(uuid())
  campaignId   String   @map("campaign_id")
  campaign     Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name         String                    // Product name
  brand        String?                   // Brand/company name
  url          String?                   // Link to product
  imageUrl     String?  @map("image_url")
  price        Decimal? @db.Decimal(10, 2)
  currency     String   @default("GBP")
  pros         String?                   // What's good about it
  cons         String?                   // What's missing/wrong
  whyNotEnough String?  @map("why_not_enough") // Why this doesn't solve the problem
  order        Int      @default(0)
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([campaignId])
  @@map("competitor_examples")
}

model CampaignMedia {
  id         String   @id @default(uuid())
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  kind       MediaKind
  url        String
  altText    String?  @map("alt_text")
  order      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([campaignId])
  @@map("campaign_media")
}

enum MediaKind {
  IMAGE
  VIDEO
  SKETCH
  MOCKUP

  @@map("media_kind")
}

model CampaignPreferenceField {
  id         String   @id @default(uuid())
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  fieldName  String   @map("field_name")
  fieldType  FieldType @map("field_type")
  options    Json?
  placeholder String?
  required   Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  lobbyPreferences LobbyPreference[]

  @@index([campaignId])
  @@map("campaign_preference_fields")
}

enum FieldType {
  TEXT
  SELECT
  MULTI_SELECT
  NUMBER
  RANGE

  @@map("field_type")
}

model CampaignUpdate {
  id         String   @id @default(uuid())
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creatorUserId String @map("creator_user_id")
  creator    User     @relation(fields: [creatorUserId], references: [id], onDelete: Cascade)
  title      String
  content    String
  updateType String?  @default("ANNOUNCEMENT") @map("update_type")
  isPinned   Boolean  @default(false) @map("is_pinned")
  media      UpdateMedia[]
  reactions  UpdateReaction[]
  comments   Comment[]
  scheduledFor DateTime? @map("scheduled_for")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([campaignId])
  @@index([creatorUserId])
  @@map("campaign_updates")
}

model UpdateMedia {
  id         String   @id @default(uuid())
  updateId   String   @map("update_id")
  update     CampaignUpdate @relation(fields: [updateId], references: [id], onDelete: Cascade)
  kind       MediaKind
  url        String
  altText    String?  @map("alt_text")
  order      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([updateId])
  @@map("update_media")
}

model UpdateReaction {
  id         String   @id @default(uuid())
  updateId   String   @map("update_id")
  update     CampaignUpdate @relation(fields: [updateId], references: [id], onDelete: Cascade)
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type       String
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([updateId, userId])
  @@index([updateId])
  @@index([userId])
  @@map("update_reactions")
}

// ============================================================================
// LOBBIES (Free Support)
// ============================================================================

model Lobby {
  id         String       @id @default(uuid())
  campaignId String       @map("campaign_id")
  campaign   Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId     String       @map("user_id")
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  intensity  LobbyIntensity
  reason     String?      @db.VarChar(280)
  status     LobbyStatus  @default(PENDING)
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  // Relations
  preferences LobbyPreference[]
  wishlists   LobbyWishlist[]

  @@unique([campaignId, userId])
  @@index([campaignId])
  @@index([userId])
  @@index([status])
  @@map("lobbies")
}

enum LobbyIntensity {
  NEAT_IDEA
  PROBABLY_BUY
  TAKE_MY_MONEY

  @@map("lobby_intensity")
}

enum LobbyStatus {
  PENDING
  VERIFIED

  @@map("lobby_status")
}

model LobbyPreference {
  id                    String   @id @default(uuid())
  lobbyId               String   @map("lobby_id")
  lobby                 Lobby    @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  campaignPreferenceFieldId String @map("campaign_preference_field_id")
  preferenceField       CampaignPreferenceField @relation(fields: [campaignPreferenceFieldId], references: [id], onDelete: Cascade)
  value                 String

  @@unique([lobbyId, campaignPreferenceFieldId])
  @@index([lobbyId])
  @@index([campaignPreferenceFieldId])
  @@map("lobby_preferences")
}

model LobbyWishlist {
  id        String   @id @default(uuid())
  lobbyId   String   @map("lobby_id")
  lobby     Lobby    @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  text      String
  createdAt DateTime @default(now()) @map("created_at")

  @@index([lobbyId])
  @@map("lobby_wishlists")
}

// ============================================================================
// PLEDGES (Financial Commitment)
// ============================================================================

model Pledge {
  id            String     @id @default(uuid())
  campaignId    String     @map("campaign_id")
  campaign      Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId        String     @map("user_id")
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  pledgeType    PledgeType @map("pledge_type")
  priceCeiling  Decimal?   @map("price_ceiling") @db.Decimal(10, 2)
  timeframeDays Int?       @map("timeframe_days")
  region        String?    @db.VarChar(50)
  options       Json?
  isPrivate     Boolean    @default(false) @map("is_private")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  @@unique([campaignId, userId, pledgeType])
  @@index([campaignId])
  @@index([userId])
  @@index([createdAt])
  @@map("pledges")
}

enum PledgeType {
  SUPPORT
  INTENT

  @@map("pledge_type")
}

// ============================================================================
// BRAND INTERACTIONS
// ============================================================================

model BrandResponse {
  id           String              @id @default(uuid())
  campaignId   String              @map("campaign_id")
  campaign     Campaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  brandId      String              @map("brand_id")
  brand        Brand               @relation(fields: [brandId], references: [id], onDelete: Cascade)
  authorUserId String              @map("author_user_id")
  author       User                @relation(fields: [authorUserId], references: [id], onDelete: Cascade)
  content      String
  responseType BrandResponseType   @map("response_type")
  createdAt    DateTime            @default(now()) @map("created_at")

  @@index([campaignId])
  @@index([brandId])
  @@index([createdAt])
  @@map("brand_responses")
}

enum BrandResponseType {
  STATUS_UPDATE
  COMMENT
  ANNOUNCEMENT

  @@map("brand_response_type")
}

model Poll {
  id         String     @id @default(uuid())
  campaignId String     @map("campaign_id")
  campaign   Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  brandId    String     @map("brand_id")
  brand      Brand      @relation(fields: [brandId], references: [id], onDelete: Cascade)
  question   String
  status     PollStatus @default(ACTIVE)
  createdAt  DateTime   @default(now()) @map("created_at")
  closedAt   DateTime?  @map("closed_at")

  options PollOption[]
  votes   PollVote[]

  @@map("polls")
}

enum PollStatus {
  ACTIVE
  CLOSED

  @@map("poll_status")
}

model PollOption {
  id         String   @id @default(uuid())
  pollId     String   @map("poll_id")
  poll       Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  optionText String   @map("option_text")
  order      Int      @default(0)

  votes PollVote[]

  @@map("poll_options")
}

model PollVote {
  pollId    String   @map("poll_id")
  poll      Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  optionId  String   @map("option_id")
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@id([pollId, userId])
  @@map("poll_votes")
}

// ============================================================================
// OFFERS & ORDERS
// ============================================================================

model Offer {
  id               String      @id @default(uuid())
  campaignId       String      @map("campaign_id")
  campaign         Campaign    @relation(fields: [campaignId], references: [id])
  brandId          String      @map("brand_id")
  brand            Brand       @relation(fields: [brandId], references: [id])
  title            String
  description      String?
  price            Decimal     @db.Decimal(10, 2)
  currency         String      @default("GBP")
  goalQuantity     Int         @map("goal_quantity")
  deadline         DateTime
  shippingRequired Boolean     @default(true) @map("shipping_required")
  status           OfferStatus @default(DRAFT)
  createdAt        DateTime    @default(now()) @map("created_at")
  activatedAt      DateTime?   @map("activated_at")
  closedAt         DateTime?   @map("closed_at")

  orders  Order[]
  payouts Payout[]

  @@index([campaignId])
  @@index([status])
  @@map("offers")
}

enum OfferStatus {
  DRAFT
  ACTIVE
  SUCCESSFUL
  FAILED
  CANCELLED

  @@map("offer_status")
}

model Order {
  id              String      @id @default(uuid())
  offerId         String      @map("offer_id")
  offer           Offer       @relation(fields: [offerId], references: [id])
  userId          String      @map("user_id")
  user            User        @relation(fields: [userId], references: [id])
  amount          Decimal     @db.Decimal(10, 2)
  currency        String
  shippingName    String?     @map("shipping_name")
  shippingLine1   String?     @map("shipping_line1")
  shippingLine2   String?     @map("shipping_line2")
  shippingCity    String?     @map("shipping_city")
  shippingPostcode String?    @map("shipping_postcode")
  shippingCountry String?     @map("shipping_country")
  status          OrderStatus @default(PAID)
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  payments Payment[]

  @@index([offerId])
  @@index([userId])
  @@map("orders")
}

enum OrderStatus {
  PAID
  REFUNDED
  CANCELLED

  @@map("order_status")
}

model Payment {
  id                      String        @id @default(uuid())
  orderId                 String        @map("order_id")
  order                   Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  provider                String        @default("stripe")
  stripePaymentIntentId   String?       @map("stripe_payment_intent_id")
  status                  PaymentStatus
  amount                  Decimal       @db.Decimal(10, 2)
  currency                String
  createdAt               DateTime      @default(now()) @map("created_at")

  @@index([stripePaymentIntentId])
  @@index([orderId])
  @@map("payments")
}

enum PaymentStatus {
  SUCCEEDED
  REFUNDED
  CHARGEBACK

  @@map("payment_status")
}

// ============================================================================
// PAYOUTS & REWARDS
// ============================================================================

model Payout {
  id           String       @id @default(uuid())
  offerId      String       @map("offer_id")
  offer        Offer        @relation(fields: [offerId], references: [id], onDelete: Cascade)
  brandId      String       @map("brand_id")
  brand        Brand        @relation(fields: [brandId], references: [id], onDelete: Cascade)
  grossAmount  Decimal      @map("gross_amount") @db.Decimal(10, 2)
  platformFee  Decimal      @map("platform_fee") @db.Decimal(10, 2)
  creatorShare Decimal      @map("creator_share") @db.Decimal(10, 2)
  heroPool     Decimal      @map("hero_pool") @db.Decimal(10, 2)
  netToBrand   Decimal      @map("net_to_brand") @db.Decimal(10, 2)
  status       PayoutStatus @default(PENDING)
  createdAt    DateTime     @default(now()) @map("created_at")
  paidAt       DateTime?    @map("paid_at")

  creatorReward CreatorReward?
  heroRewards   HeroReward[]

  @@index([offerId])
  @@index([brandId])
  @@index([status])
  @@map("payouts")
}

enum PayoutStatus {
  PENDING
  PAID
  FAILED

  @@map("payout_status")
}

model CreatorReward {
  id            String       @id @default(uuid())
  campaignId    String       @map("campaign_id")
  campaign      Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creatorUserId String       @map("creator_user_id")
  creator       User         @relation(fields: [creatorUserId], references: [id], onDelete: Cascade)
  payoutId      String       @unique @map("payout_id")
  payout        Payout       @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  amount        Decimal      @db.Decimal(10, 2)
  status        RewardStatus @default(PENDING)
  createdAt     DateTime     @default(now()) @map("created_at")
  paidAt        DateTime?    @map("paid_at")

  @@index([campaignId])
  @@index([creatorUserId])
  @@index([status])
  @@map("creator_rewards")
}

model HeroReward {
  id                String       @id @default(uuid())
  campaignId        String       @map("campaign_id")
  campaign          Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId            String       @map("user_id")
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  payoutId          String       @map("payout_id")
  payout            Payout       @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  amount            Decimal      @db.Decimal(10, 2)
  contributionScore Int          @map("contribution_score")
  status            RewardStatus @default(PENDING)
  createdAt         DateTime     @default(now()) @map("created_at")
  paidAt            DateTime?    @map("paid_at")

  @@index([campaignId])
  @@index([userId])
  @@index([payoutId])
  @@index([status])
  @@map("hero_rewards")
}

enum RewardStatus {
  PENDING
  PAID

  @@map("reward_status")
}

// ============================================================================
// SOCIAL FEATURES
// ============================================================================

model Follow {
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now()) @map("created_at")

  @@id([campaignId, userId])
  @@index([campaignId])
  @@index([userId])
  @@map("follows")
}

model ContributionEvent {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaignId  String   @map("campaign_id")
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  eventType   ContributionEventType @map("event_type")
  points      Int
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([campaignId])
  @@index([eventType])
  @@index([createdAt])
  @@map("contribution_events")
}

enum ContributionEventType {
  PREFERENCE_SUBMITTED
  WISHLIST_SUBMITTED
  REFERRAL_SIGNUP
  COMMENT_ENGAGEMENT
  SOCIAL_SHARE
  BRAND_OUTREACH

  @@map("contribution_event_type")
}

model ReferralLink {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  code       String   @unique
  clickCount Int      @default(0) @map("click_count")
  signupCount Int     @default(0) @map("signup_count")
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([userId, campaignId])
  @@index([code])
  @@index([userId])
  @@index([campaignId])
  @@map("referral_links")
}

model Share {
  id             String   @id @default(uuid())
  campaignId     String   @map("campaign_id")
  userId         String?  @map("user_id")
  platform       String   // TWITTER, FACEBOOK, WHATSAPP, EMAIL, COPY_LINK, REFERRAL
  referralCode   String?  @unique @map("referral_code")
  clickCount     Int      @default(0) @map("click_count")
  createdAt      DateTime @default(now()) @map("created_at")

  campaign       Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user           User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([userId])
  @@index([referralCode])
  @@map("shares")
}

// ============================================================================
// FAVOURITES
// ============================================================================

model Favourite {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  campaignId String   @map("campaign_id")
  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([userId, campaignId])
  @@index([userId])
  @@index([campaignId])
  @@map("favourites")
}

// ============================================================================
// COMMENTS
// ============================================================================

model Comment {
  id         String    @id @default(uuid())
  content    String
  campaignId String    @map("campaign_id")
  userId     String    @map("user_id")
  parentId   String?   @map("parent_id")
  status     String    @default("VISIBLE") // VISIBLE, HIDDEN, FLAGGED
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  updateId   String?   @map("update_id")

  campaign   Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent     Comment?        @relation("CommentReplies", fields: [parentId], references: [id])
  replies    Comment[]       @relation("CommentReplies")
  update     CampaignUpdate? @relation(fields: [updateId], references: [id], onDelete: Cascade)

  @@index([campaignId, createdAt])
  @@index([userId])
  @@index([parentId])
  @@index([updateId])
  @@map("comments")
}

// ============================================================================
// MODERATION
// ============================================================================

model Report {
  id             String       @id @default(uuid())
  reporterUserId String       @map("reporter_user_id")
  reporter       User         @relation("reporter", fields: [reporterUserId], references: [id])
  targetType     TargetType   @map("target_type")
  targetId       String       @map("target_id")
  reason         String
  details        String?
  status         ReportStatus @default(OPEN)
  createdAt      DateTime     @default(now()) @map("created_at")
  resolvedAt     DateTime?    @map("resolved_at")

  @@index([status])
  @@map("reports")
}

enum TargetType {
  CAMPAIGN
  OFFER
  BRAND_RESPONSE
  BRAND
  USER

  @@map("target_type")
}

enum ReportStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  DISMISSED

  @@map("report_status")
}

model ModerationAction {
  id          String         @id @default(uuid())
  adminUserId String         @map("admin_user_id")
  admin       User           @relation("admin", fields: [adminUserId], references: [id], onDelete: Cascade)
  action      ModerationType
  targetType  TargetType     @map("target_type")
  targetId    String         @map("target_id")
  notes       String?
  createdAt   DateTime       @default(now()) @map("created_at")

  @@index([adminUserId])
  @@index([createdAt])
  @@map("moderation_actions")
}

enum ModerationType {
  REMOVE
  BAN
  WARN
  SHADOWBAN
  RESTORE

  @@map("moderation_type")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  title     String
  message   String
  linkUrl   String?  @map("link_url")
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// NOTIFICATION PREFERENCES
// ============================================================================

model NotificationPreference {
  id                    String   @id @default(uuid())
  userId                String   @unique @map("user_id")
  emailDigestFrequency  String   @default("WEEKLY") @map("email_digest_frequency")
  emailCampaignUpdates  Boolean  @default(true) @map("email_campaign_updates")
  emailBrandResponses   Boolean  @default(true) @map("email_brand_responses")
  emailNewFollowers     Boolean  @default(false) @map("email_new_followers")
  emailMilestones       Boolean  @default(true) @map("email_milestones")
  pushEnabled           Boolean  @default(true) @map("push_enabled")
  lastDigestSentAt      DateTime? @map("last_digest_sent_at")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// ============================================================================
// CREATOR POLLS (Preference Data Collection)
// ============================================================================

model CreatorPoll {
  id           String           @id @default(uuid())
  campaignId   String           @map("campaign_id")
  campaign     Campaign         @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creatorId    String           @map("creator_id")
  creator      User             @relation("creatorPolls", fields: [creatorId], references: [id], onDelete: Cascade)
  question     String
  description  String?
  pollType     CreatorPollType  @map("poll_type")
  maxSelections Int             @default(1) @map("max_selections")
  status       CreatorPollStatus @default(ACTIVE)
  closesAt     DateTime?        @map("closes_at")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  options  CreatorPollOption[]
  votes    CreatorPollVote[]

  @@index([campaignId])
  @@index([creatorId])
  @@index([status])
  @@map("creator_polls")
}

enum CreatorPollType {
  SINGLE_SELECT
  MULTI_SELECT
  RANKED

  @@map("creator_poll_type")
}

enum CreatorPollStatus {
  ACTIVE
  CLOSED
  DRAFT

  @@map("creator_poll_status")
}

model CreatorPollOption {
  id        String   @id @default(uuid())
  pollId    String   @map("poll_id")
  poll      CreatorPoll @relation(fields: [pollId], references: [id], onDelete: Cascade)
  text      String
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  votes CreatorPollVote[]

  @@index([pollId])
  @@map("creator_poll_options")
}

model CreatorPollVote {
  id        String   @id @default(uuid())
  pollId    String   @map("poll_id")
  poll      CreatorPoll @relation(fields: [pollId], references: [id], onDelete: Cascade)
  optionId  String   @map("option_id")
  option    CreatorPollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  user      User     @relation("creatorPollVotes", fields: [userId], references: [id], onDelete: Cascade)
  rank      Int?
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([pollId, userId, optionId])
  @@index([pollId])
  @@index([userId])
  @@map("creator_poll_votes")
}

// ============================================================================
// CAMPAIGN Q&A
// ============================================================================

model Question {
  id           String         @id @default(uuid())
  campaignId   String         @map("campaign_id")
  campaign     Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId       String         @map("user_id")
  user         User           @relation("questions", fields: [userId], references: [id], onDelete: Cascade)
  content      String
  answer       String?
  answeredById String?        @map("answered_by_id")
  answeredBy   User?          @relation("answers", fields: [answeredById], references: [id])
  answeredAt   DateTime?      @map("answered_at")
  isPinned     Boolean        @default(false) @map("is_pinned")
  status       QuestionStatus @default(OPEN)
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  votes QuestionVote[]

  @@index([campaignId, createdAt])
  @@index([campaignId, isPinned])
  @@index([userId])
  @@map("questions")
}

enum QuestionStatus {
  OPEN
  ANSWERED
  CLOSED

  @@map("question_status")
}

model QuestionVote {
  questionId String   @map("question_id")
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now()) @map("created_at")

  @@id([questionId, userId])
  @@map("question_votes")
}

// ============================================================================
// BRAND OUTREACH & AUTOMATION
// ============================================================================

model OutreachQueue {
  id            String   @id @default(uuid())
  campaignId    String   @map("campaign_id")
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  brandEmail    String   @map("brand_email")
  brandName     String   @map("brand_name")
  subject       String
  htmlContent   String   @map("html_content")
  plainTextContent String @map("plain_text_content")
  status        OutreachStatus @default(PENDING)
  sentAt        DateTime? @map("sent_at")
  openedAt      DateTime? @map("opened_at")
  respondedAt   DateTime? @map("responded_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([campaignId])
  @@index([status])
  @@index([createdAt])
  @@map("outreach_queue")
}

enum OutreachStatus {
  PENDING
  SENT
  FAILED
  OPENED
  RESPONDED

  @@map("outreach_status")
}

model OutreachTemplate {
  id        String   @id @default(uuid())
  name      String
  subject   String
  htmlBody  String   @map("html_body")
  textBody  String   @map("text_body")
  variables Json?
  tier      String // BRONZE, SILVER, GOLD, PLATINUM
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tier])
  @@map("outreach_templates")
}

// ============================================================================
// SURVEYS
// ============================================================================

model Survey {
  id                String           @id @default(uuid())
  campaignId        String           @map("campaign_id")
  campaign          Campaign         @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  brandId           String           @map("brand_id")
  brand             Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  creatorUserId     String           @map("creator_user_id")
  creator           User             @relation("surveys", fields: [creatorUserId], references: [id], onDelete: Cascade)
  title             String
  description       String?
  surveyType        SurveyType       @map("survey_type")
  status            SurveyStatus     @default(DRAFT)
  isAnonymous       Boolean          @default(false) @map("is_anonymous")
  responseCount     Int              @default(0) @map("response_count")
  completionRate    Float?           @map("completion_rate")
  publishedAt       DateTime?        @map("published_at")
  closedAt          DateTime?        @map("closed_at")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  questions       SurveyQuestion[]
  responses       SurveyResponse[]

  @@index([campaignId])
  @@index([brandId])
  @@index([status])
  @@map("surveys")
}

enum SurveyType {
  QUICK_POLL
  DETAILED_SURVEY
  NPS_SURVEY
  FEATURE_PRIORITY

  @@map("survey_type")
}

enum SurveyStatus {
  DRAFT
  PUBLISHED
  CLOSED

  @@map("survey_status")
}

model SurveyQuestion {
  id            String           @id @default(uuid())
  surveyId      String           @map("survey_id")
  survey        Survey           @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  question      String
  description   String?
  questionType  QuestionType     @map("question_type")
  options       Json?            // For multiple_choice and ranking
  minScale      Int?             @map("min_scale")  // For rating scales
  maxScale      Int?             @map("max_scale")
  minLabel      String?          @map("min_label")
  maxLabel      String?          @map("max_label")
  required      Boolean          @default(false)
  order         Int              @default(0)
  createdAt     DateTime         @default(now()) @map("created_at")

  responses     SurveyAnswer[]

  @@index([surveyId])
  @@map("survey_questions")
}

enum QuestionType {
  MULTIPLE_CHOICE
  RATING_SCALE
  OPEN_TEXT
  RANKING
  MATRIX

  @@map("question_type")
}

model SurveyResponse {
  id            String           @id @default(uuid())
  surveyId      String           @map("survey_id")
  survey        Survey           @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  userId        String?          @map("user_id")
  user          User?            @relation("surveyResponses", fields: [userId], references: [id], onDelete: SetNull)
  lobbyIntensity LobbyIntensity?  @map("lobby_intensity")
  completedAt   DateTime?        @map("completed_at")
  createdAt     DateTime         @default(now()) @map("created_at")

  answers       SurveyAnswer[]

  @@index([surveyId])
  @@index([userId])
  @@index([createdAt])
  @@map("survey_responses")
}

model SurveyAnswer {
  id              String           @id @default(uuid())
  responseId      String           @map("response_id")
  response        SurveyResponse   @relation(fields: [responseId], references: [id], onDelete: Cascade)
  questionId      String           @map("question_id")
  question        SurveyQuestion   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer          String           // JSON-encoded answer
  createdAt       DateTime         @default(now()) @map("created_at")

  @@unique([responseId, questionId])
  @@index([responseId])
  @@index([questionId])
  @@map("survey_answers")
}

// ============================================================================
// CREATOR REVENUE
// ============================================================================

model CreatorRevenue {
  id                    String         @id @default(uuid())
  creatorUserId         String         @map("creator_user_id")
  creator               User           @relation(fields: [creatorUserId], references: [id], onDelete: Cascade)
  totalEarnings         Decimal        @default(0) @map("total_earnings") @db.Decimal(12, 2)
  referralBonus         Decimal        @default(0) @map("referral_bonus") @db.Decimal(12, 2)
  campaignSuccessFees   Decimal        @default(0) @map("campaign_success_fees") @db.Decimal(12, 2)
  tipJarEarnings        Decimal        @default(0) @map("tip_jar_earnings") @db.Decimal(12, 2)
  totalPaid             Decimal        @default(0) @map("total_paid") @db.Decimal(12, 2)
  totalPending          Decimal        @default(0) @map("total_pending") @db.Decimal(12, 2)
  updatedAt             DateTime       @updatedAt @map("updated_at")
  createdAt             DateTime       @default(now()) @map("created_at")

  payoutRequests        PayoutRequest[]
  revenueBreakdowns     RevenueBreakdown[]

  @@unique([creatorUserId])
  @@map("creator_revenue")
}

model RevenueBreakdown {
  id                String        @id @default(uuid())
  creatorRevenueId  String        @map("creator_revenue_id")
  creatorRevenue    CreatorRevenue @relation(fields: [creatorRevenueId], references: [id], onDelete: Cascade)
  campaignId        String        @map("campaign_id")
  campaign          Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  amount            Decimal       @db.Decimal(12, 2)
  source            RevenueSource
  createdAt         DateTime      @default(now()) @map("created_at")

  @@index([creatorRevenueId])
  @@index([campaignId])
  @@map("revenue_breakdowns")
}

enum RevenueSource {
  REFERRAL_BONUS
  CAMPAIGN_SUCCESS
  TIP_JAR

  @@map("revenue_source")
}

model PayoutRequest {
  id                String           @id @default(uuid())
  creatorRevenueId  String           @map("creator_revenue_id")
  creatorRevenue    CreatorRevenue   @relation(fields: [creatorRevenueId], references: [id], onDelete: Cascade)
  amount            Decimal          @db.Decimal(12, 2)
  status            PayoutRequestStatus @default(PENDING)
  bankName          String?          @map("bank_name")
  accountHolder     String?          @map("account_holder")
  accountNumber     String?          @map("account_number") @db.VarChar(20)
  sortCode          String?          @map("sort_code") @db.VarChar(10)
  ibanCode          String?          @map("iban_code") @db.VarChar(34)
  swiftCode         String?          @map("swift_code") @db.VarChar(11)
  currency          String           @default("GBP")
  requestedAt       DateTime         @default(now()) @map("requested_at")
  processedAt       DateTime?        @map("processed_at")
  completedAt       DateTime?        @map("completed_at")
  notes             String?
  createdAt         DateTime         @default(now()) @map("created_at")

  @@index([creatorRevenueId])
  @@index([status])
  @@map("payout_requests")
}

enum PayoutRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED

  @@map("payout_request_status")
}
